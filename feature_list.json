{
  "project_name": "TML Villa",
  "description": "泰国民宿管理平台 - 自有业务模式，包含民宿、租车(可配司机)、订餐、票务",
  "business_model": {
    "type": "self_owned",
    "services": ["homestay", "car_rental", "meal", "ticket"],
    "vs_airbnb": "所有业务自有，非商家入驻模式"
  },
  "deployment_constraints": {
    "netlify_free": {
      "bandwidth": "100GB/月",
      "build_minutes": "300分钟/月",
      "risk": "low",
      "optimization": "图片用 Supabase Storage"
    },
    "render_free": {
      "hours": "750小时/月",
      "ram": "512MB",
      "sleep": "15分钟无活动休眠",
      "risk": "medium",
      "optimization": "Edge Functions 绕过冷启动，避免内存缓存"
    },
    "supabase_free": {
      "database": "500MB",
      "bandwidth": "5GB/月",
      "storage": "2GB",
      "risk": "high",
      "optimization": "数据归档、索引优化、限制字段长度"
    }
  },
  "payment_status": {
    "current": "暂不实现",
    "future": "P3 优先级，后续迭代",
    "workaround": "订单确认由管理员手动操作"
  },
  "tech_stack": {
    "frontend": "React + TypeScript + Vite",
    "backend": "Node.js + Express + Prisma",
    "database": "PostgreSQL (Supabase)",
    "styling": "Tailwind CSS + shadcn/ui"
  },
  "features": [
    {
      "id": "F001",
      "category": "bugfix",
      "priority": "P0",
      "title": "首页 API 错误修复",
      "status": "done",
      "passes": true,
      "notes": "Edge Functions 生效"
    },
    {
      "id": "F002",
      "category": "deployment",
      "priority": "P0",
      "title": "Netlify 部署验证",
      "status": "done",
      "passes": true,
      "notes": "完成"
    },
    {
      "id": "F003",
      "category": "performance",
      "priority": "P0",
      "title": "首页加载性能优化",
      "status": "done",
      "passes": true,
      "notes": "API 响应 ~1.2s"
    },
    {
      "id": "F004",
      "category": "auth",
      "priority": "P0",
      "title": "用户注册/登录系统",
      "description": "用户邮箱注册、登录、登出",
      "free_limit_impact": "无影响，JWT 无状态",
      "steps": ["注册页面", "邮箱验证", "登录/登出", "Token 管理"],
      "acceptance_criteria": ["用户可注册", "可登录登出", "密码加密存储"],
      "status": "missing",
      "passes": false
    },
    {
      "id": "F005",
      "category": "booking",
      "priority": "P0",
      "title": "民宿预订流程",
      "description": "无支付模式的预订流程：选择日期 → 提交预订 → 管理员确认",
      "free_limit_impact": "无影响",
      "steps": ["选择日期", "选择人数", "提交预订", "后台确认/拒绝"],
      "acceptance_criteria": ["日期校验库存", "生成订单", "管理员可确认/拒绝"],
      "status": "partial",
      "passes": false,
      "notes": "有详情页，缺预订提交和确认流程"
    },
    {
      "id": "F006",
      "category": "payment",
      "priority": "P3",
      "title": "支付集成（未来）",
      "description": "后续迭代，暂不实现",
      "status": "planned",
      "passes": false,
      "notes": "降级为 P3，无支付时由管理员手动确认订单"
    },
    {
      "id": "F007",
      "category": "inventory",
      "priority": "P0",
      "title": "民宿库存管理",
      "description": "管理房间可用性，支持日期维度库存",
      "free_limit_impact": "⚠️ 高影响 - 500MB 数据库限制",
      "optimization": "只存未来90天库存，过期自动删除",
      "steps": ["设置房间数量", "日历视图", "预订扣减", "取消释放"],
      "acceptance_criteria": ["日历显示可用性", "预订校验库存", "超售保护"],
      "status": "missing",
      "passes": false
    },
    {
      "id": "F008",
      "category": "inventory",
      "priority": "P0",
      "title": "车辆库存管理（含配司机）",
      "description": "管理车辆可用性，支持配司机选项",
      "free_limit_impact": "⚠️ 高影响 - 需司机排班表",
      "optimization": "排班表只存未来30天",
      "steps": ["车辆数量管理", "司机配置", "日期库存", "预订校验"],
      "acceptance_criteria": ["车辆日历", "可配司机选项", "司机排班"],
      "status": "missing",
      "passes": false
    },
    {
      "id": "F009",
      "category": "user",
      "priority": "P1",
      "title": "用户中心",
      "description": "用户个人中心：订单、收藏、个人信息",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F010",
      "category": "review",
      "priority": "P1",
      "title": "评价系统",
      "description": "用户评价民宿/服务",
      "free_limit_impact": "⚠️ 中影响 - 评价内容占存储",
      "optimization": "评价字数限制200字，图片最多3张",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F011",
      "category": "notification",
      "priority": "P1",
      "title": "消息通知",
      "description": "订单状态变更通知",
      "free_limit_impact": "⚠️ 高影响 - 通知记录占存储",
      "optimization": "通知只保留30天",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F012",
      "category": "staff",
      "priority": "P1",
      "title": "员工管理",
      "description": "管理司机、清洁、前台等员工",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false,
      "notes": "自有业务特有需求"
    },
    {
      "id": "F013",
      "category": "finance",
      "priority": "P1",
      "title": "成本核算",
      "description": "自有业务成本管理",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false,
      "notes": "自有业务特有需求"
    },
    {
      "id": "F014",
      "category": "report",
      "priority": "P1",
      "title": "运营报表",
      "description": "收入/订单/用户数据报表",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F015",
      "category": "calendar",
      "priority": "P1",
      "title": "管理端日历视图",
      "description": "日历查看房间/车辆可用性",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F016",
      "category": "monitoring",
      "priority": "P1",
      "title": "免费额度监控",
      "description": "监控 Supabase/Netlify/Render 免费额度使用情况",
      "free_limit_impact": "核心功能",
      "steps": ["数据库大小监控", "带宽使用监控", "预警通知"],
      "acceptance_criteria": ["超80%预警", "Dashboard显示使用量"],
      "status": "missing",
      "passes": false,
      "notes": "防止超限导致服务中断"
    },
    {
      "id": "F017",
      "category": "search",
      "priority": "P2",
      "title": "搜索优化",
      "description": "高级搜索和筛选",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F018",
      "category": "favorite",
      "priority": "P2",
      "title": "收藏功能",
      "description": "用户收藏民宿",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F019",
      "category": "i18n",
      "priority": "P2",
      "title": "多语言完善",
      "description": "中/英/泰三语支持",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F020",
      "category": "mobile",
      "priority": "P2",
      "title": "移动端适配",
      "description": "优化移动端体验",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F021",
      "category": "tech",
      "priority": "P2",
      "title": "错误边界组件",
      "description": "防止白屏",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F022",
      "category": "marketing",
      "priority": "P2",
      "title": "营销工具",
      "description": "优惠券、促销活动",
      "free_limit_impact": "⚠️ 中影响 - 优惠券数据",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F023",
      "category": "merchant",
      "priority": "P3",
      "title": "商家入驻（未来）",
      "description": "支持第三方商家入驻",
      "status": "planned",
      "passes": false
    },
    {
      "id": "F024",
      "category": "membership",
      "priority": "P3",
      "title": "会员系统（未来）",
      "description": "积分、会员等级",
      "status": "planned",
      "passes": false
    },
    {
      "id": "F025",
      "category": "testing",
      "priority": "P2",
      "title": "单元测试",
      "description": "核心功能测试",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F026",
      "category": "config",
      "priority": "P0",
      "title": "业务配置系统",
      "description": "统一管理各业务线的配置，包括订单确认模式开关",
      "free_limit_impact": "无影响",
      "config_items": {
        "homestay_manual_confirm": "民宿订单是否需要人工确认（默认true）",
        "car_manual_confirm": "租车订单是否需要人工确认（默认true）",
        "meal_manual_confirm": "餐饮订单是否需要人工确认（默认false）",
        "ticket_manual_confirm": "票务订单是否需要人工确认（默认false）"
      },
      "steps": ["创建配置表", "管理后台配置界面", "订单流程读取配置"],
      "acceptance_criteria": ["管理员可切换确认模式", "配置实时生效", "每种业务独立配置"],
      "status": "missing",
      "passes": false,
      "notes": "核心功能：所有业务都有独立的确认模式开关"
    }
  ],
  "data_model_optimizations": {
    "storage_strategy": {
      "house_stock": "只存未来90天，过期删除",
      "driver_schedule": "只存未来30天",
      "notifications": "只保留30天",
      "order_logs": "归档到单独表"
    },
    "field_constraints": {
      "description": "最大500字符",
      "remark": "最大200字符",
      "review_content": "最大200字符"
    },
    "index_strategy": {
      "orders": "[status, createdAt]",
      "stocks": "[date]",
      "schedules": "[date, status]"
    },
    "business_config_model": {
      "description": "业务配置表 - 核心功能，存储各业务线的开关和参数",
      "prisma_schema": "model BusinessConfig { id String @id @default(cuid()) key String @unique value String description String? updatedAt DateTime @updatedAt @@map(\"business_configs\") }",
      "default_configs": [
        { "key": "homestay.manual_confirm", "value": "true" },
        { "key": "car.manual_confirm", "value": "true" },
        { "key": "meal.manual_confirm", "value": "false" },
        { "key": "ticket.manual_confirm", "value": "false" }
      ]
    }
  },
  "order_flow_without_payment": {
    "description": "订单确认模式由后台配置决定，每种业务独立配置",
    "default_settings": {
      "homestay": { "manual_confirm": true, "note": "民宿默认需要人工确认" },
      "car": { "manual_confirm": true, "note": "租车默认需要人工确认" },
      "meal": { "manual_confirm": false, "note": "餐饮默认即时确认" },
      "ticket": { "manual_confirm": false, "note": "票务默认即时确认" }
    },
    "instant_confirm_flow": "用户预订 → 自动确认 → 完成",
    "manual_confirm_flow": "用户预订 → 管理员确认/拒绝 → 完成/取消",
    "states": ["pending", "confirmed", "completed", "cancelled"],
    "config_feature": "F026 业务配置系统"
  },
  "metadata": {
    "created_at": "2026-02-20T00:00:00Z",
    "updated_at": "2026-02-20T05:35:00Z",
    "total_features": 26,
    "done_features": 3,
    "missing_features": 14,
    "partial_features": 6,
    "planned_features": 3,
    "priority_breakdown": {
      "P0": 7,
      "P1": 7,
      "P2": 6,
      "P3": 6
    },
    "high_risk_features": ["F007", "F008", "F011"],
    "next_feature": "F004 - 用户注册/登录系统"
  }
}
