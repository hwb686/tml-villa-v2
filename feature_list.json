{
  "project_name": "TML Villa",
  "description": "泰国民宿管理平台 - 自有业务模式，包含民宿、租车(可配司机)、订餐、票务",
  "business_model": {
    "type": "self_owned",
    "services": ["homestay", "car_rental", "meal", "ticket"],
    "vs_airbnb": "所有业务自有，非商家入驻模式"
  },
  "deployment_constraints": {
    "netlify_free": {
      "bandwidth": "100GB/月",
      "build_minutes": "300分钟/月",
      "risk": "low",
      "optimization": "图片用 Supabase Storage"
    },
    "render_free": {
      "hours": "750小时/月",
      "ram": "512MB",
      "sleep": "15分钟无活动休眠",
      "risk": "medium",
      "optimization": "Edge Functions 绕过冷启动，避免内存缓存"
    },
    "supabase_free": {
      "database": "500MB",
      "bandwidth": "5GB/月",
      "storage": "2GB",
      "risk": "high",
      "optimization": "数据归档、索引优化、限制字段长度"
    }
  },
  "payment_status": {
    "current": "暂不实现",
    "future": "P3 优先级，后续迭代",
    "workaround": "订单确认由管理员手动操作"
  },
  "tech_stack": {
    "frontend": "React + TypeScript + Vite",
    "backend": "Node.js + Express + Prisma",
    "database": "PostgreSQL (Supabase)",
    "styling": "Tailwind CSS + shadcn/ui"
  },
  "features": [
    {
      "id": "F000",
      "category": "bugfix",
      "priority": "P0",
      "title": "【紧急】后台管理界面白屏修复",
      "description": "管理后台页面 http://localhost:5173/#/admin 显示白屏，需要检查并修复问题",
      "status": "done",
      "passes": true,
      "steps": [
        "检查 AdminApp.tsx 是否有渲染错误",
        "检查浏览器控制台错误信息",
        "检查路由配置是否正确",
        "修复导致白屏的代码问题"
      ],
      "acceptance_criteria": [
        "管理后台能正常显示",
        "无控制台错误",
        "侧边栏导航正常工作"
      ],
      "notes": "已于 2026-02-21 修复。问题原因：Header.tsx 文件格式错误（所有代码在一行），导致 React.Children.only 错误。修复方式：重新格式化 Header.tsx 文件。同时更新了 seed.js 中的默认密码。"
    },
    {
      "id": "F001",
      "category": "bugfix",
      "priority": "P0",
      "title": "首页 API 错误修复",
      "status": "done",
      "passes": true,
      "notes": "Edge Functions 生效"
    },
    {
      "id": "F002",
      "category": "deployment",
      "priority": "P0",
      "title": "Netlify 部署验证",
      "status": "done",
      "passes": true,
      "notes": "完成"
    },
    {
      "id": "F003",
      "category": "performance",
      "priority": "P0",
      "title": "首页加载性能优化",
      "status": "done",
      "passes": true,
      "notes": "API 响应 ~1.2s"
    },
    {
      "id": "F004",
      "category": "auth",
      "priority": "P0",
      "title": "用户注册/登录系统",
      "description": "用户邮箱注册、登录、登出",
      "free_limit_impact": "无影响，JWT 无状态",
      "steps": ["注册页面", "邮箱验证", "登录/登出", "Token 管理"],
      "acceptance_criteria": ["用户可注册", "可登录登出", "密码加密存储"],
      "status": "done",
      "passes": true,
      "notes": "API已完成: POST /api/auth/register, POST /api/auth/login, POST /api/auth/logout, GET /api/auth/me。密码使用bcrypt加密"
    },
    {
      "id": "F005",
      "category": "booking",
      "priority": "P0",
      "title": "民宿预订流程",
      "description": "无支付模式的预订流程：选择日期 → 提交预订 → 管理员确认",
      "free_limit_impact": "无影响",
      "steps": ["选择日期", "选择人数", "提交预订", "后台确认/拒绝"],
      "acceptance_criteria": ["日期校验库存", "生成订单", "管理员可确认/拒绝"],
      "status": "done",
      "passes": true,
      "notes": "API已完成: POST /api/bookings, GET /api/bookings/:id, PUT /api/bookings/:id/confirm, PUT /api/bookings/:id/cancel。支持未登录用户预订，自动创建guest账户。集成业务配置系统决定确认模式。"
    },
    {
      "id": "F006",
      "category": "payment",
      "priority": "P3",
      "title": "支付集成（未来）",
      "description": "后续迭代，暂不实现",
      "status": "planned",
      "passes": false,
      "notes": "降级为 P3，无支付时由管理员手动确认订单"
    },
    {
      "id": "F007",
      "category": "inventory",
      "priority": "P0",
      "title": "民宿库存管理",
      "description": "管理房间可用性，支持日期维度库存",
      "free_limit_impact": "⚠️ 高影响 - 500MB 数据库限制",
      "optimization": "只存未来90天库存，过期自动删除",
      "steps": ["设置房间数量", "日历视图", "预订扣减", "取消释放"],
      "acceptance_criteria": ["日历显示可用性", "预订校验库存", "超售保护"],
      "status": "done",
      "passes": true,
      "notes": "已完成: 后端API包括获取库存、初始化库存、更新库存、批量设置、清理过期库存、获取不可用日期；前端StockManagement页面实现日历视图；预订流程集成库存检查和扣减；取消订单自动释放库存；fetchAdminApi实现管理员权限认证"
    },
    {
      "id": "F008",
      "category": "inventory",
      "priority": "P0",
      "title": "车辆库存管理（含配司机）",
      "description": "管理车辆可用性，支持配司机选项",
      "free_limit_impact": "⚠️ 高影响 - 需司机排班表",
      "optimization": "排班表只存未来30天",
      "steps": ["车辆数量管理", "司机配置", "日期库存", "预订校验"],
      "acceptance_criteria": ["车辆日历", "可配司机选项", "司机排班"],
      "status": "done",
      "passes": true,
      "notes": "已完成: 后端API包括车辆库存管理(CarStock)、司机管理(Driver)、司机排班(DriverSchedule)；前端页面包括车辆库存日历(CarStockManagement)、司机管理(Drivers)、司机排班管理(DriverSchedule)；车辆配置支持可配司机选项和司机费用设置"
    },
    {
      "id": "F009",
      "category": "user",
      "priority": "P1",
      "title": "用户中心",
      "description": "用户个人中心：订单、收藏、个人信息",
      "free_limit_impact": "无影响",
      "status": "done",
      "passes": true,
      "notes": "已完成: 后端API包括用户信息更新、密码修改、收藏管理; 前端页面包括用户中心页面(UserCenter)、登录注册页面(LoginPage); Navbar组件添加用户登录状态显示; 添加Favorite数据模型"
    },
    {
      "id": "F010",
      "category": "review",
      "priority": "P1",
      "title": "评价系统",
      "description": "用户评价民宿/服务",
      "free_limit_impact": "⚠️ 中影响 - 评价内容占存储",
      "optimization": "评价字数限制200字，图片最多3张",
      "status": "done",
      "passes": true,
      "notes": "已完成: 后端API包括评价CRUD、管理员回复、状态管理、评分统计; 前端组件包括星级评分(StarRating)、评价统计(RatingStats)、评价卡片(ReviewCard)、评价列表(ReviewList)、评价表单(ReviewForm); 管理后台评价管理页面(Reviews); 民宿详情页评价展示; 用户中心我的评价; 只有已完成的订单才能评价; 评价字数限制200字，图片最多3张",
      "steps": [
        "创建评价（需要已完成订单）",
        "获取评价列表（支持按民宿筛选）",
        "管理员回复评价",
        "管理员隐藏/显示评价",
        "评分统计（平均分、分布）"
      ],
      "acceptance_criteria": [
        "用户可以为已完成的订单写评价",
        "星级评分1-5星",
        "评价内容最多200字",
        "最多上传3张图片",
        "管理员可以回复评价",
        "管理员可以隐藏不当评价",
        "民宿详情页显示评价统计和列表"
      ]
    },
    {
      "id": "F011",
      "category": "notification",
      "priority": "P1",
      "title": "消息通知",
      "description": "订单状态变更通知",
      "free_limit_impact": "⚠️ 高影响 - 通知记录占存储",
      "optimization": "通知只保留30天",
      "status": "done",
      "passes": true,
      "steps": [
        "创建 Notification 数据模型",
        "实现后端通知 API",
        "订单状态变更时自动创建通知",
        "前端通知铃铛和下拉面板",
        "用户中心通知管理页面"
      ],
      "acceptance_criteria": [
        "用户可以看到通知列表",
        "未读数量红点提示",
        "可以标记已读和删除",
        "订单确认/取消时自动通知"
      ],
      "notes": "已于 2026-02-21 完成。后端API包括获取通知列表、获取未读数量、标记已读、标记全部已读、删除通知、清理过期通知；前端包括通知铃铛组件(NotificationBell)和用户中心通知标签页；订单确认和取消时自动创建通知；通知只保留30天（可配置清理）"
    },
    {
      "id": "F012",
      "category": "staff",
      "priority": "P1",
      "title": "员工管理",
      "description": "管理司机、清洁、前台等员工",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false,
      "notes": "自有业务特有需求"
    },
    {
      "id": "F013",
      "category": "finance",
      "priority": "P1",
      "title": "成本核算",
      "description": "自有业务成本管理",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false,
      "notes": "自有业务特有需求"
    },
    {
      "id": "F014",
      "category": "report",
      "priority": "P1",
      "title": "运营报表",
      "description": "收入/订单/用户数据报表",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F015",
      "category": "calendar",
      "priority": "P1",
      "title": "管理端日历视图",
      "description": "日历查看房间/车辆可用性",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F016",
      "category": "monitoring",
      "priority": "P1",
      "title": "免费额度监控",
      "description": "监控 Supabase/Netlify/Render 免费额度使用情况",
      "free_limit_impact": "核心功能",
      "steps": ["数据库大小监控", "带宽使用监控", "预警通知"],
      "acceptance_criteria": ["超80%预警", "Dashboard显示使用量"],
      "status": "missing",
      "passes": false,
      "notes": "防止超限导致服务中断"
    },
    {
      "id": "F017",
      "category": "search",
      "priority": "P2",
      "title": "搜索优化",
      "description": "高级搜索和筛选",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F018",
      "category": "favorite",
      "priority": "P2",
      "title": "收藏功能",
      "description": "用户收藏民宿",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F019",
      "category": "i18n",
      "priority": "P2",
      "title": "多语言完善",
      "description": "中/英/泰三语支持",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F020",
      "category": "mobile",
      "priority": "P2",
      "title": "移动端适配",
      "description": "优化移动端体验",
      "free_limit_impact": "无影响",
      "status": "partial",
      "passes": false
    },
    {
      "id": "F021",
      "category": "tech",
      "priority": "P2",
      "title": "错误边界组件",
      "description": "防止白屏",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F022",
      "category": "marketing",
      "priority": "P2",
      "title": "营销工具",
      "description": "优惠券、促销活动",
      "free_limit_impact": "⚠️ 中影响 - 优惠券数据",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F023",
      "category": "merchant",
      "priority": "P3",
      "title": "商家入驻（未来）",
      "description": "支持第三方商家入驻",
      "status": "planned",
      "passes": false
    },
    {
      "id": "F024",
      "category": "membership",
      "priority": "P3",
      "title": "会员系统（未来）",
      "description": "积分、会员等级",
      "status": "planned",
      "passes": false
    },
    {
      "id": "F025",
      "category": "testing",
      "priority": "P2",
      "title": "单元测试",
      "description": "核心功能测试",
      "free_limit_impact": "无影响",
      "status": "missing",
      "passes": false
    },
    {
      "id": "F026",
      "category": "config",
      "priority": "P0",
      "title": "业务配置系统",
      "description": "统一管理各业务线的配置，包括订单确认模式开关",
      "free_limit_impact": "无影响",
      "config_items": {
        "homestay_manual_confirm": "民宿订单是否需要人工确认（默认true）",
        "car_manual_confirm": "租车订单是否需要人工确认（默认true）",
        "meal_manual_confirm": "餐饮订单是否需要人工确认（默认false）",
        "ticket_manual_confirm": "票务订单是否需要人工确认（默认false）"
      },
      "steps": ["创建配置表", "管理后台配置界面", "订单流程读取配置"],
      "acceptance_criteria": ["管理员可切换确认模式", "配置实时生效", "每种业务独立配置"],
      "status": "done",
      "passes": true,
      "notes": "API已完成: GET /api/config, GET /api/config/:key, PUT /api/config/:key, POST /api/config, DELETE /api/config/:key。支持缓存，需要管理员权限才能修改配置。"
    }
  ],
  "data_model_optimizations": {
    "storage_strategy": {
      "house_stock": "只存未来90天，过期删除",
      "driver_schedule": "只存未来30天",
      "notifications": "只保留30天",
      "order_logs": "归档到单独表"
    },
    "field_constraints": {
      "description": "最大500字符",
      "remark": "最大200字符",
      "review_content": "最大200字符"
    },
    "index_strategy": {
      "orders": "[status, createdAt]",
      "stocks": "[date]",
      "schedules": "[date, status]"
    },
    "business_config_model": {
      "description": "业务配置表 - 核心功能，存储各业务线的开关和参数",
      "prisma_schema": "model BusinessConfig { id String @id @default(cuid()) key String @unique value String description String? updatedAt DateTime @updatedAt @@map(\"business_configs\") }",
      "default_configs": [
        { "key": "homestay.manual_confirm", "value": "true" },
        { "key": "car.manual_confirm", "value": "true" },
        { "key": "meal.manual_confirm", "value": "false" },
        { "key": "ticket.manual_confirm", "value": "false" }
      ]
    }
  },
  "order_flow_without_payment": {
    "description": "订单确认模式由后台配置决定，每种业务独立配置",
    "default_settings": {
      "homestay": { "manual_confirm": true, "note": "民宿默认需要人工确认" },
      "car": { "manual_confirm": true, "note": "租车默认需要人工确认" },
      "meal": { "manual_confirm": false, "note": "餐饮默认即时确认" },
      "ticket": { "manual_confirm": false, "note": "票务默认即时确认" }
    },
    "instant_confirm_flow": "用户预订 → 自动确认 → 完成",
    "manual_confirm_flow": "用户预订 → 管理员确认/拒绝 → 完成/取消",
    "states": ["pending", "confirmed", "completed", "cancelled"],
    "config_feature": "F026 业务配置系统"
  },
  "metadata": {
    "created_at": "2026-02-20T00:00:00Z",
    "updated_at": "2026-02-20T15:30:00Z",
    "total_features": 27,
    "done_features": 6,
    "in_progress_features": 1,
    "missing_features": 13,
    "partial_features": 5,
    "planned_features": 3,
    "priority_breakdown": {
      "P0": 6,
      "P1": 7,
      "P2": 6,
      "P3": 6
    },
    "high_risk_features": ["F007", "F008", "F011"],
    "next_feature": "F000 - 【紧急】后台管理界面白屏修复"
  }
}
