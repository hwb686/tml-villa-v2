import { createClient } from '@supabase/supabase-js' // Supabase配置 const supabaseUrl = import.meta.env.VITE_SUPABASE_URL const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY // 默认 bucket 名称 const defaultBucket = import.meta.env.VITE_SUPABASE_BUCKET || 'homestay-images' // 各模块使用的 bucket 名称 export const STORAGE_BUCKETS = { homestay: 'homestay-images', meal: 'meal-images', car: 'car-images', ticket: 'ticket-images', } as const // 验证环境变量 if (!supabaseUrl || !supabaseAnonKey) { console.warn('Supabase环境变量未配置，请在.env文件中设置 VITE_SUPABASE_URL 和 VITE_SUPABASE_ANON_KEY') } // 创建Supabase客户端实例 export const supabase = supabaseUrl && supabaseAnonKey ? createClient(supabaseUrl, supabaseAnonKey) : null // 图片上传工具函数（支持指定 bucket） export async function uploadImage(file: File, bucket: string = defaultBucket): Promise<string> { if (!supabase) { throw new Error('Supabase客户端未初始化，请检查环境变量配置') } try { const fileName = `${Date.now()}_${file.name}` const { error } = await supabase.storage .from(bucket) .upload(fileName, file, { cacheControl: '3600', upsert: false }) if (error) { throw new Error(`上传失败: ${error.message}`) } // 获取公共URL const { data } = supabase.storage .from(bucket) .getPublicUrl(fileName) return data.publicUrl } catch (error) { console.error('图片上传错误:', error) throw error } } // 批量上传图片 export async function uploadImages(files: File[], bucket?: string): Promise<string[]> { const uploadPromises = files.map(file => uploadImage(file, bucket)) return Promise.all(uploadPromises) } // 从URL中提取 bucket 名称和文件名 function extractBucketAndFileName(url: string): { bucket: string; fileName: string } | null { try { const urlObj = new URL(url) const pathParts = urlObj.pathname.split('/') // Supabase URL格式: /storage/v1/object/public/bucket-name/filename // 找到 'public' 后面的部分 const publicIndex = pathParts.findIndex(p => p === 'public') if (publicIndex === -1 || publicIndex + 2 >= pathParts.length) { return null } const bucket = pathParts[publicIndex + 1] const fileName = pathParts[publicIndex + 2] return { bucket, fileName } } catch { return null } } // 删除单张图片 export async function deleteImage(imageUrl: string): Promise<void> { if (!supabase) { throw new Error('Supabase客户端未初始化') } const result = extractBucketAndFileName(imageUrl) if (!result) { console.warn('无法从URL提取文件名:', imageUrl) return } try { const { error } = await supabase.storage .from(result.bucket) .remove([result.fileName]) if (error) { console.error('删除图片失败:', error) } } catch (error) { console.error('删除图片错误:', error) } } // 批量删除图片 export async function deleteImages(imageUrls: string[]): Promise<void> { await Promise.all(imageUrls.map(url => deleteImage(url))) }