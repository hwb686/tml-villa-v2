generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  username     String     @unique
  email        String     @unique
  phone        String?
  password     String
  role         String     @default("USER")
  status       String     @default("active")
  avatar       String?
  isHost       Boolean    @default(false)
  createdAt    DateTime   @default(now()) @map("create_time")
  updatedAt    DateTime   @updatedAt
  orders       Order[]
  favorites    Favorite[]
  reviews      Review[]
  notifications Notification[]
  
  @@map("users")
}

// 用户收藏
model Favorite {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  houseId     String   @map("house_id")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  house       Homestay @relation(fields: [houseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, houseId])
  @@map("favorites")
}

model Homestay {
  id          String     @id @default(cuid())
  title       String
  location    String
  price       Int
  rating      Float      @default(4.5)
  reviews     Int        @default(0)
  images      String[]
  type        String
  guests      Int
  bedrooms    Int
  beds        Int
  bathrooms   Int
  amenities   String[]
  description String?
  isFavorite  Boolean    @default(false)
  hostName    String
  hostAvatar  String
  isSuperhost Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  orders      Order[]
  stocks      HouseStock[]
  favorites   Favorite[]
  reviewList  Review[]
  
  @@map("homestays")
}

model HouseStock {
  id          String   @id @default(cuid())
  houseId     String   @map("house_id")
  date        DateTime @db.Date
  totalStock  Int      @default(1) @map("total_stock")
  bookedStock Int      @default(0) @map("booked_stock")
  price       Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  house       Homestay @relation(fields: [houseId], references: [id], onDelete: Cascade)
  
  @@unique([houseId, date])
  @@index([date])
  @@map("house_stocks")
}

model Order {
  id          String   @id @default(cuid())
  orderId     String   @unique @map("order_id")
  userId      String   @map("user_id")
  houseId     String   @map("house_id")
  type        String   @default("homestay")
  itemName    String   @map("item_name")
  totalPrice  Int      @map("total_price")
  status      String   @default("pending")
  checkIn     DateTime? @map("check_in")
  checkOut    DateTime? @map("check_out")
  guests      Int?
  createdAt   DateTime @default(now()) @map("create_time")
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])
  house       Homestay @relation(fields: [houseId], references: [id])
  review      Review?
  
  @@map("orders")
}

// 餐饮配置（后台可配置菜单）
model MealConfig {
  id          String   @id @default(cuid())
  name        String   // 套餐名称，如"泰式早餐套餐"
  description String?  // 套餐描述
  image       String   // 套餐图片URL
  price       Int      // 套餐价格（泰铢/人）
  mealType    String   @map("meal_type") // BREAKFAST 或 DINNER
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("create_time")
  updatedAt   DateTime @updatedAt
  
  orders      MealOrder[]
  
  @@map("meal_configs")
}

model MealOrder {
  id            String   @id @default(cuid())
  roomNumber    String   @map("room_number") // 房号，替代订单号
  mealConfigId  String   @map("meal_config_id") // 选择的套餐ID
  mealType      String   @map("meal_type") // BREAKFAST 或 DINNER
  peopleCount   Int      @map("people_count")
  totalPrice    Int      @map("total_price") // 总价
  remark        String?
  status        String   @default("CONFIRMED")
  createdAt     DateTime @default(now()) @map("create_time")
  updatedAt     DateTime @updatedAt
  
  mealConfig    MealConfig @relation(fields: [mealConfigId], references: [id])
  
  @@map("meal_orders")
}

// 车辆配置（后台可配置）
model CarConfig {
  id             String   @id @default(cuid())
  name           String   // 车辆名称，如"丰田凯美瑞"
  description    String?  // 车辆描述
  image          String   // 车辆图片URL
  price          Int      // 租赁价格（泰铢/天）
  carType        String   @map("car_type") // 车型：SUV、轿车、电动车等
  seats          Int      // 座位数
  hasDriver      Boolean  @default(true) @map("has_driver") // 可否配司机
  driverFee      Int      @default(0) @map("driver_fee") // 司机每日费用
  isActive       Boolean  @default(true) @map("is_active")
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("create_time")
  updatedAt      DateTime @updatedAt
  
  rentals        CarRental[]
  stocks         CarStock[]
  
  @@map("car_configs")
}

model CarRental {
  id            String   @id @default(cuid())
  roomNumber    String   @map("room_number") // 房号
  carConfigId   String   @map("car_config_id") // 选择的车辆ID
  startTime     DateTime @map("start_time")
  endTime       DateTime @map("end_time")
  days          Int      // 租赁天数
  totalPrice    Int      @map("total_price") // 总价
  remark        String?
  status        String   @default("PENDING")
  needDriver    Boolean  @default(false) @map("need_driver") // 是否需要司机
  driverId      String?  @map("driver_id") // 分配的司机ID
  driverFee     Int?     @map("driver_fee") // 司机费用
  createdAt     DateTime @default(now()) @map("create_time")
  updatedAt     DateTime @updatedAt
  
  carConfig     CarConfig  @relation(fields: [carConfigId], references: [id])
  driver        Driver?    @relation(fields: [driverId], references: [id])
  
  @@map("car_rentals")
}

// 车辆库存（日期维度）
model CarStock {
  id            String   @id @default(cuid())
  carConfigId   String   @map("car_config_id")
  date          DateTime @db.Date
  totalStock    Int      @default(1) @map("total_stock")
  bookedStock   Int      @default(0) @map("booked_stock")
  price         Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  carConfig     CarConfig @relation(fields: [carConfigId], references: [id], onDelete: Cascade)
  
  @@unique([carConfigId, date])
  @@index([date])
  @@map("car_stocks")
}

// 司机信息
model Driver {
  id            String   @id @default(cuid())
  name          String   // 司机姓名
  phone         String   // 联系电话
  avatar        String?  // 头像
  licenseNumber String?  @map("license_number") // 驾照号
  status        String   @default("active") // active, inactive, on_leave
  dailyFee      Int      @default(0) @map("daily_fee") // 每日费用
  remark        String?  // 备注
  createdAt     DateTime @default(now()) @map("create_time")
  updatedAt     DateTime @updatedAt
  
  schedules     DriverSchedule[]
  rentals       CarRental[]
  
  @@map("drivers")
}

// 司机排班（日期维度）
model DriverSchedule {
  id            String   @id @default(cuid())
  driverId      String   @map("driver_id")
  date          DateTime @db.Date
  status        String   @default("available") // available, booked, off
  remark        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
   
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
   
  @@unique([driverId, date])
  @@index([date, status])
  @@map("driver_schedules")
}

// 员工信息（司机之外的员工：清洁工、前台、管理员等）
model Staff {
  id            String   @id @default(cuid())
  name          String   // 员工姓名
  phone         String   // 联系电话
  avatar        String?  // 头像
  staffType     String   @map("staff_type") // cleaner, receptionist, admin, maintenance, other
  status        String   @default("active") // active, inactive, on_leave
  dailyWage     Int      @default(0) @map("daily_wage") // 日薪
  idNumber      String?  @map("id_number") // 身份证号
  emergencyContact String? @map("emergency_contact") // 紧急联系人
  emergencyPhone String? @map("emergency_phone") // 紧急联系电话
  hireDate      DateTime? @map("hire_date") // 入职日期
  remark        String?  // 备注
  createdAt     DateTime @default(now()) @map("create_time")
  updatedAt     DateTime @updatedAt
   
  schedules     StaffSchedule[]
   
  @@index([staffType])
  @@index([status])
  @@map("staffs")
}

// 员工排班（日期维度）
model StaffSchedule {
  id            String   @id @default(cuid())
  staffId       String   @map("staff_id")
  date          DateTime @db.Date
  status        String   @default("scheduled") // scheduled, working, completed, absent, off
  workHours     Int?     @map("work_hours") // 工作时长（小时）
  remark        String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
   
  staff         Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
   
  @@unique([staffId, date])
  @@index([date, status])
  @@map("staff_schedules")
}

model Category {
  id        String   @id @default(cuid())
  labelZh   String   @map("label_zh")
  labelEn   String   @map("label_en")
  labelTh   String   @map("label_th")
  icon      String
  sortOrder Int      @default(0) @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("categories")
}

model Transaction {
  id          String   @id @default(cuid())
  type        String
  amount      Int
  description String
  createdAt   DateTime @default(now()) @map("create_time")
  updatedAt   DateTime @updatedAt
  
  @@map("transactions")
}

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now()) @map("create_time")
  updatedAt DateTime @updatedAt
  
  @@map("admins")
}

// 票务配置（后台可配置）
model TicketConfig {
  id          String   @id @default(cuid())
  name        String   // 票务名称，如"大皇宫门票"
  description String?  // 票务描述
  image       String   // 票务图片URL
  price       Int      // 票务价格（泰铢/张）
  ticketType  String   @map("ticket_type") // 类型：景点、表演、游艇等
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("create_time")
  updatedAt   DateTime @updatedAt
  
  orders      TicketOrder[]
  
  @@map("ticket_configs")
}

model TicketOrder {
  id            String   @id @default(cuid())
  roomNumber    String   @map("room_number") // 房号
  ticketConfigId String  @map("ticket_config_id") // 选择的票务ID
  quantity      Int      // 预订数量
  totalPrice    Int      @map("total_price") // 总价
  visitDate     DateTime? @map("visit_date") // 参观日期（可选）
  remark        String?
  status        String   @default("CONFIRMED")
  createdAt     DateTime @default(now()) @map("create_time")
  updatedAt     DateTime @updatedAt
  
  ticketConfig  TicketConfig @relation(fields: [ticketConfigId], references: [id])
  
  @@map("ticket_orders")
}

// 业务配置（后台可配置各业务线的确认模式）
model BusinessConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("business_configs")
}

// 用户评价
model Review {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  houseId     String   @map("house_id")
  orderId     String   @unique @map("order_id") // 一个订单只能评价一次
  rating      Int      // 1-5 星级评分
  content     String?  @db.Text // 评价内容，最多200字
  images      String[] // 评价图片，最多3张
  reply       String?  @db.Text // 管理员回复
  replyAt     DateTime? @map("reply_at") // 回复时间
  status      String   @default("active") // active, hidden
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  house       Homestay @relation(fields: [houseId], references: [id], onDelete: Cascade)
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([houseId])
  @@index([userId])
  @@map("reviews")
}

// 用户通知
model Notification {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  type        String   // notification type: order_confirmed, order_cancelled, review_reminder, system
  title       String   // 通知标题
  content     String   @db.Text // 通知内容
  data        String?  @db.Text // JSON格式的附加数据（如订单ID等）
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}
